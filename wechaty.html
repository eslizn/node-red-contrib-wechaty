<script type="text/javascript">
(function () {
    const withAuthorization = (xhr) => {
        xhr.setRequestHeader('Node-RED-API-Version', 'v2');
        if (RED.settings.get("auth-tokens")) {
            xhr.setRequestHeader('Authorization', 'Bearer ' + RED.settings.get("auth-tokens").access_token);
        }
    }

    RED.nodes.registerType("wechaty", {
        category: "social",
        defaults: {
            name: {value: 'wechaty'},
            puppet: {value: 'wechaty-puppet-wechat4u', required: true},
            puppetOptions: {value: "{}"}
        },
        color: '#44a838',
        inputs: 1,
        outputs: 1,
        icon: "wechaty-logo.png",
        label: function () {
            return this.name || 'wechaty';
        },
        oneditprepare: function () {
            $("#node-input-puppet").typedInput({types: [{options: [
                {value: "wechaty-puppet-wechat4u", label: "wechaty-puppet-wechat4u"},
                {value: "wechaty-puppet-service", label: "wechaty-puppet-service"}
            ]}]});
            $("#node-input-puppetOptions").typedInput({type:"json", types:["json"]});
            this.refresh = () => {
                $.ajax({
                    url: '/context/node/' + this.id,
                    dataType: 'json',
                    beforeSend: withAuthorization,
                }).then((data) => {
                    data = Object.values(data).length ? Object.values(data)[0] : data;
                    if (data && data.qrcode && data.qrcode.msg && data.qrcode.msg.indexOf('https://') === 0) {
                        $('#node-input-qrcode').attr('src', data.qrcode.msg.replace('/l/', '/qrcode/'));
                        $('#node-input-qrcode').parent().show();
                    } else {
                        $('#node-input-qrcode').parent().hide();
                    }
                }).fail(() => {
                    console.log(arguments);
                }).always(() => {
                    if (this.refresh) {
                        setTimeout(this.refresh, 3000);
                    }
                });
            };
            this.refresh();
        },
        oneditcancel: function () {
            this.refresh = undefined;
        },
        oneditsave: function () {
            this.refresh = undefined;
        }
    });
})()
</script>

<script type="text/html" data-template-name="wechaty">
 <div class="form-row">
     <label for="node-input-name"><i class="fa fa-weixin"></i> Name</label>
     <input type="text" id="node-input-name" />
 </div>
 <div class="form-row">
     <label for="node-input-puppet"><i class="fa fa-microchip"></i> Puppet</label>
     <input type="text" id="node-input-puppet" />
 </div>
 <div class="form-row">
     <label for="node-input-puppetOptions"><i class="fa fa-cog"></i> Options</label>
     <input type="text" id="node-input-puppetOptions" />
 </div>
 <div class="form-row" style="display:none;">
     <label for="node-input-qrcode"><i class="fa fa-qrcode"></i> QRCode</label>
     <img id="node-input-qrcode" src="" alt="" />
 </div>
</script>
